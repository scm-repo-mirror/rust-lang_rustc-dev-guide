<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Stabilizing language features - Rust Compiler Development Guide</title>


        <!-- Custom HTML head -->

        <meta name="description" content="A guide to developing the Rust compiler (rustc)">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="pagetoc.css">


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Rust Compiler Development Guide</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/rust-lang/rustc-dev-guide" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/rust-lang/rustc-dev-guide/edit/main/src/stabilization_guide.md" title="Suggest an edit" aria-label="Suggest an edit" rel="edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="request-for-stabilization"><a class="header" href="#request-for-stabilization">Request for stabilization</a></h1>
<p><strong>NOTE</strong>: This page is about stabilizing <em>language</em> features.
For stabilizing <em>library</em> features, see <a href="./stability.html#stabilizing-a-library-feature">Stabilizing a library feature</a>.</p>
<p>Once an unstable feature has been well-tested with no outstanding concerns, anyone may push for its stabilization, though involving the people who have worked on it is prudent.
Follow these steps:</p>
<h2 id="write-an-rfc-if-needed"><a class="header" href="#write-an-rfc-if-needed">Write an RFC, if needed</a></h2>
<p>If the feature was part of a <a href="https://lang-team.rust-lang.org/how_to/experiment.html">lang experiment</a>, the lang team generally will want to first accept an RFC before stabilization.</p>
<h2 id="documentation-prs"><a class="header" href="#documentation-prs">Documentation PRs</a></h2>
<p><a id="updating-documentation"></a></p>
<p>The feature might be documented in the <a href="https://doc.rust-lang.org/unstable-book/index.html"><code>Unstable Book</code></a>, located at <a href="https://github.com/rust-lang/rust/tree/HEAD/src/doc/unstable-book"><code>src/doc/unstable-book</code></a>.
Remove the page for the feature gate if it exists.
Integrate any useful parts of that documentation in other places.</p>
<p>Places that may need updated documentation include:</p>
<ul>
<li><a href="https://github.com/rust-lang/reference">The Reference</a>: This must be updated, in full detail, and a member of the lang-docs team must review and approve the PR before the stabilization can be merged.</li>
<li><a href="https://github.com/rust-lang/book">The Book</a>: This is updated as needed.
If you're not sure, please open an issue on this repository and it can be discussed.</li>
<li>Standard library documentation: This is updated as needed.
Language features often don't need this, but if it's a feature that changes how idiomatic examples are written, such as when <code>?</code> was added to the language, updating these in the library documentation is important.
Review also the keyword documentation and ABI documentation in the standard library, as these sometimes need updates for language changes.</li>
<li><a href="https://github.com/rust-lang/rust-by-example">Rust by Example</a>: This is updated as needed.</li>
</ul>
<p>Prepare PRs to update documentation involving this new feature for the repositories mentioned above.
Maintainers of these repositories will keep these PRs open until the whole stabilization process has completed.
Meanwhile, we can proceed to the next step.</p>
<h2 id="write-a-stabilization-report"><a class="header" href="#write-a-stabilization-report">Write a stabilization report</a></h2>
<p>Author a stabilization report using the <a href="./stabilization_report_template.html">template found in this repository</a>.</p>
<p>The stabilization reports summarizes:</p>
<ul>
<li>The main design decisions and deviations since the RFC was accepted, including both decisions that were FCP'd or otherwise accepted by the language team as well as those being presented to the lang team for the first time.
<ul>
<li>Often, the final stabilized language feature has significant design deviations from the original RFC.
That's OK, but these deviations must be highlighted and explained carefully.</li>
</ul>
</li>
<li>The work that has been done since the RFC was accepted, acknowledging the main contributors that helped drive the language feature forward.</li>
</ul>
<p>The <a href="./stabilization_report_template.html"><em>Stabilization Template</em></a> includes a series of questions that aim to surface connections between this feature and lang's subteams (e.g. types, opsem, lang-docs, etc.) and to identify items that are commonly overlooked.</p>
<p>The stabilization report is typically posted as the main comment on the stabilization PR (see the next section).</p>
<h2 id="stabilization-pr"><a class="header" href="#stabilization-pr">Stabilization PR</a></h2>
<p>Every feature is different, and some may require steps beyond what this guide discusses.</p>
<p>Before the stabilization will be considered by the lang team, there must be a complete PR to the Reference describing the feature, and before the stabilization PR will be merged, this PR must have been reviewed and approved by the lang-docs team.</p>
<h3 id="updating-the-feature-gate-listing"><a class="header" href="#updating-the-feature-gate-listing">Updating the feature-gate listing</a></h3>
<p>There is a central listing of unstable feature-gates in <a href="https://github.com/rust-lang/rust/tree/HEAD/compiler/rustc_feature/src/unstable.rs"><code>compiler/rustc_feature/src/unstable.rs</code></a>.
Search for the <code>declare_features!</code>  macro.
There should be an entry for the feature you are aiming to stabilize,
something like the following (taken from <a href="https://github.com/rust-lang/rust/issues/32409">rust-lang/rust#32409</a>:</p>
<pre><code class="language-rust ignore">// pub(restricted) visibilities (RFC 1422)
(unstable, pub_restricted, "CURRENT_RUSTC_VERSION", Some(32409)),</code></pre>
<p>The above line should be moved to <a href="https://github.com/rust-lang/rust/tree/HEAD/compiler/rustc_feature/src/accepted.rs"><code>compiler/rustc_feature/src/accepted.rs</code></a>.
Entries in the <code>declare_features!</code> call are sorted, so find the correct place.
When it is done, it should look like:</p>
<pre><code class="language-rust ignore">// pub(restricted) visibilities (RFC 1422)
(accepted, pub_restricted, "CURRENT_RUSTC_VERSION", Some(32409)),
// note that we changed this</code></pre>
<p>(Even though you will encounter version numbers in the file of past changes, you should not put the rustc version you expect your stabilization to happen in, but instead use <code>CURRENT_RUSTC_VERSION</code>.)</p>
<h3 id="removing-existing-uses-of-the-feature-gate"><a class="header" href="#removing-existing-uses-of-the-feature-gate">Removing existing uses of the feature-gate</a></h3>
<p>Next, search for the feature string (in this case, <code>pub_restricted</code>) in the codebase to find where it appears.
Change uses of <code>#![feature(XXX)]</code> from the <code>std</code> and any rustc crates
(which includes test folders under <code>library/</code> and <code>compiler/</code> but not the toplevel <code>tests/</code> one)
to be <code>#![cfg_attr(bootstrap, feature(XXX))]</code>.
This includes the feature-gate only for stage0, which is built using the current beta (this is needed because the feature is still unstable in the current beta).</p>
<p>Also, remove those strings from any tests (e.g. under <code>tests/</code>). If there are tests specifically targeting the feature-gate (i.e., testing that the feature-gate is required to use the feature, but nothing else), simply remove the test.</p>
<h3 id="do-not-require-the-feature-gate-to-use-the-feature"><a class="header" href="#do-not-require-the-feature-gate-to-use-the-feature">Do not require the feature-gate to use the feature</a></h3>
<p>Most importantly, remove the code which flags an error if the feature-gate is not present (since the feature is now considered stable).
If the feature can be detected because it employs some new syntax, then a common place for that code to be is in <code>compiler/rustc_ast_passes/src/feature_gate.rs</code>.
For example, you might see code like this:</p>
<pre><code class="language-rust ignore">gate_all!(pub_restricted, "`pub(restricted)` syntax is experimental");</code></pre>
<p>The <code>gate_all!</code> macro reports an error if the <code>pub_restricted</code> feature is not enabled.
It is not needed now that <code>pub(restricted)</code> is stable.</p>
<p>For more subtle features, you may find code like this:</p>
<pre><code class="language-rust ignore">if self.tcx.features().async_fn_in_dyn_trait() { /* XXX */ }</code></pre>
<p>This <code>pub_restricted</code> field (named after the feature) would ordinarily be false if the feature flag is not present and true if it is.
So, transform the code to assume that the field is true.
In this case, that would mean removing the <code>if</code> and leaving just the <code>/* XXX */</code>.</p>
<pre><code class="language-rust ignore">if self.tcx.sess.features.borrow().pub_restricted { /* XXX */ }
becomes
/* XXX */

if self.tcx.sess.features.borrow().pub_restricted &amp;&amp; something { /* XXX */ }
 becomes
if something { /* XXX */ }</code></pre>
<h2 id="team-nominations"><a class="header" href="#team-nominations">Team nominations</a></h2>
<p>When opening the stabilization PR, CC the lang team and its advisors (<code>@rust-lang/lang @rust-lang/lang-advisors</code>) and any other teams to whom the feature is relevant, e.g.:</p>
<ul>
<li><code>@rust-lang/types</code>, for type system interactions.</li>
<li><code>@rust-lang/opsem</code>, for interactions with unsafe code.</li>
<li><code>@rust-lang/compiler</code>, for implementation robustness.</li>
<li><code>@rust-lang/libs-api</code>, for changes to the standard library API or its guarantees.</li>
<li><code>@rust-lang/lang-docs</code>, for questions about how this should be documented in the Reference.</li>
</ul>
<p>After the stabilization PR is opened with the stabilization report, wait a bit for any immediate comments.
When such comments "simmer down" and you feel the PR is ready for consideration by the lang team, <a href="https://lang-team.rust-lang.org/how_to/nominate.html">nominate the PR</a> to get it on the agenda for consideration in an upcoming lang meeting.</p>
<p>If you are not a <code>rust-lang</code> organization member, you can ask your assigned reviewer to CC the relevant teams on your behalf.</p>
<h2 id="propose-fcp-on-the-pr"><a class="header" href="#propose-fcp-on-the-pr">Propose FCP on the PR</a></h2>
<p>After the lang team and other relevant teams review the stabilization, and after you have answered any questions they may have had, a member of one of the teams may propose to accept the stabilization by commenting:</p>
<pre><code class="language-text">@rfcbot fcp merge
</code></pre>
<p>Once enough team members have reviewed, the PR will move into a "final comment period" (FCP).
If no new concerns are raised, this period will complete and the PR can be merged after implementation review in the usual way.</p>
<h2 id="reviewing-and-merging-stabilizations"><a class="header" href="#reviewing-and-merging-stabilizations">Reviewing and merging stabilizations</a></h2>
<p>On a stabilization, before giving it the <code>r+</code>, ensure that the PR:</p>
<ul>
<li>Matches what the team proposed for stabilization and what is documented in the Reference PR.</li>
<li>Includes any changes the team decided to request along the way in order to resolve or avoid concerns.</li>
<li>Is otherwise exactly what is described in the stabilization report and in any relevant RFCs or prior lang FCPs.</li>
<li>Does not expose on stable behaviors other than those specified, accepted for stabilization, and documented in the Reference.</li>
<li>Has sufficient tests to convincingly demonstrate these things.</li>
<li>Is accompanied by a PR to the Reference than has been reviewed and approved by a member of lang-docs.</li>
</ul>
<p>In particular, when reviewing the PR, keep an eye out for any user-visible details that the lang team failed to consider and specify.
If you find one, describe it and nominate the PR for the lang team.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="stability.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="stabilization_report_template.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="stability.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="stabilization_report_template.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->
        <script src="mermaid.min.js"></script>
        <script src="mermaid-init.js"></script>
        <script src="pagetoc.js"></script>



    </div>
    </body>
</html>
